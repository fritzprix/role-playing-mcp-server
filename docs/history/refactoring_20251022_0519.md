# Refactoring Plan: Game Over Restart UX Implementation

**Date:** 2025-10-22 05:19  
**Author:** AI Assistant  
**Status:** Planning

---

## 작업의 목적

Game Over 화면에서 사용자가 자연스럽게 게임을 재시작할 수 있는 UX를 제공하여, 플레이어 경험을 개선하고 게임 재도전을 유도합니다.

### 핵심 목표

- Game Over UI에 Restart 버튼 추가
- 새로운 `selectRestart` Tool 구현
- 최종 게임 상태 요약 제공 및 AI Agent가 새 게임을 시작하도록 유도

---

## 현재의 상태 / 문제점

### 현재 구조

1. **Game Over UI (`generateGameOverUI`)**
   - 정적 HTML만 반환
   - 사용자 상호작용 요소 없음
   - 게임 종료 후 재시작 방법이 명시되지 않음

2. **Tool 구성**
   - 6개의 core tools: `createGame`, `updateGame`, `getGame`, `progressStory`, `promptUserActions`, `selectAction`
   - 재시작을 위한 전용 tool 없음

3. **UX 흐름**

   ```
   Game Over → (막다른 골목) → 수동으로 createGame 재호출 필요
   ```

### 문제점

- **불편한 재시작 절차**: 사용자가 Chat에서 "새 게임 시작해줘"를 별도로 요청해야 함
- **맥락 단절**: 이전 게임의 교훈이나 상태가 새 게임에 반영되지 않음
- **일관성 부족**: 다른 action들은 UI 버튼으로 호출 가능하지만, 재시작은 불가능

---

## 변경 이후의 상태 / 해결 판정 기준

### 목표 상태

1. **Game Over UI**
   - "🔄 Restart Game" 버튼 추가
   - 버튼 클릭 시 `selectRestart` tool 자동 호출
   - 기존 `selectAction` 패턴과 일관된 UX

2. **새로운 Tool: `selectRestart`**
   - 최종 게임 상태 조회 및 요약
   - AI Agent에게 `createGame` 호출을 권장하는 응답 반환
   - Text part로 게임 요약 + 다음 단계 가이드 제공

3. **UX 흐름**

   ```
   Game Over → Restart 버튼 클릭 → selectRestart 호출 → 
   최종 상태 요약 + createGame 권장 → AI가 새 게임 생성
   ```

### 해결 판정 기준

✅ **성공 조건:**

- [ ] Game Over UI에 Restart 버튼이 렌더링됨
- [ ] 버튼 클릭 시 `selectRestart` tool이 올바르게 호출됨
- [ ] `selectRestart` 응답에 최종 게임 상태 요약이 포함됨
- [ ] AI Agent가 응답을 받고 `createGame`을 자동으로 호출함
- [ ] 새 게임이 정상적으로 시작됨

⚠️ **검증 포인트:**

- postMessage 패턴이 MCP client에서 정상 작동
- Tool 체인 (selectRestart → createGame) 자연스럽게 연결
- 에러 핸들링 (존재하지 않는 gameId 등)

---

## 수정이 필요한 코드 및 수정 부분

### 1. Type 정의 추가 (`src/types.ts`)

**위치:** Tool parameter interfaces 섹션

```typescript
export interface SelectRestartParams {
  gameId: string;
}
```

**추가 위치:** `SelectActionParams` 다음

---

### 2. Tool 등록 (`src/index.ts` - `setupHandlers()`)

**위치:** `ListToolsRequestSchema` handler의 tools 배열

```typescript
{
  name: 'selectRestart',
  description: 
    "Restart the game after game over. Retrieves final game state summary and instructs to create a new game. This should be called when the player clicks the Restart button on the Game Over screen.",
  inputSchema: {
    type: 'object',
    properties: {
      gameId: { 
        type: 'string', 
        description: 'ID of the ended game' 
      }
    },
    required: ['gameId']
  }
}
```

**추가 위치:** `selectAction` tool 정의 다음

---

### 3. Tool 호출 핸들러 추가 (`src/index.ts` - `setupHandlers()`)

**위치:** CallToolRequestSchema handler의 switch 문

```typescript
case 'selectRestart':
  result = await this.handleSelectRestart(
    toolArgs as unknown as SelectRestartParams
  );
  break;
```

**추가 위치:** `selectAction` case 다음

---

### 4. Handler 메서드 구현 (`src/index.ts`)

**위치:** RPGMCPServer 클래스 내부, `handleSelectAction` 다음

```typescript
private async handleSelectRestart(params: SelectRestartParams): Promise<CallToolResult> {
  if (!params.gameId) {
    throw new Error('gameId parameter is required');
  }

  const result = this.gameManager.getGame(params.gameId);

  // 최종 상태 요약
  const finalState = {
    title: result.game.state.title,
    endedAt: result.game.updatedAt,
    characters: result.game.state.characters,
    world: result.game.state.world,
    finalProgress: result.game.state.lastStoryProgress,
    historyCount: result.game.state.gameHistory?.length || 0,
  };

  const responseText = this.formatToolResponse(
    'selectRestart',
    'success',
    'Player requested game restart',
    {
      gameId: params.gameId,
      title: result.game.state.title,
      keyState: [
        `Game ended at: ${result.game.updatedAt.toISOString()}`,
        `Total decisions made: ${finalState.historyCount}`,
        'Ready to start fresh',
      ],
    },
    `Game "${result.game.state.title}" has ended. Player wants to start a new adventure.`,
    {
      tool: 'createGame',
      reason: 'Create a fresh game with new initial state for the player',
      params: {
        initialStateInJson: {
          title: 'Suggest a new adventure based on the previous game experience',
          characters: 'Create new characters (can reference previous if helpful)',
          world: 'Design a new world and starting situation',
        },
      },
    },
    'Restart Flow: Game Over → [selectRestart] → createGame → progressStory',
    [
      'Previous game summary provided for context',
      'Player is ready for a new adventure',
      'Consider lessons learned from previous game when creating new one',
      `Previous game had ${finalState.historyCount} story decisions`,
    ]
  );

  return {
    content: [{ type: 'text', text: responseText }],
  };
}
```

---

### 5. Game Over UI 업데이트 (`src/index.ts` - `generateGameOverUI()`)

**수정 부분:** HTML 내부, retry-message 섹션 다음에 버튼 추가

```typescript
<div class="restart-button-section">
  <button class="restart-button" onclick="selectRestart('${gameId}')">
    🔄 Restart Game
  </button>
</div>

<style>
  .restart-button-section {
    margin-top: 30px;
    text-align: center;
  }
  .restart-button {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 10px;
    padding: 15px 40px;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
  }
  .restart-button:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.6);
  }
  .restart-button:active {
    transform: translateY(0);
  }
</style>

<script>
  function selectRestart(gameId) {
    // MCP 도구 호출
    window.parent.postMessage({
      type: 'tool',
      payload: {
        toolName: 'selectRestart',
        params: { gameId: gameId }
      }
    }, '*');
    
    // 버튼 비활성화 및 피드백
    const button = event.target;
    button.disabled = true;
    button.textContent = '🔄 Restarting...';
    button.style.opacity = '0.6';
  }
</script>
```

---

## 재사용 가능한 연관 코드

### 참고할 기존 패턴

1. **`handleSelectAction` (`src/index.ts`)**
   - 파일 위치: `src/index.ts:779-831`
   - 주요 기능: 사용자 선택 처리 및 게임 히스토리 업데이트
   - 인터페이스: `SelectActionParams { gameId, selectedOption, selectedIndex }`
   - 참고 포인트: formatToolResponse 사용 패턴, nextStep 설정

2. **`generateGameUI` JavaScript 섹션 (`src/index.ts`)**
   - 파일 위치: `src/index.ts:604-776`
   - 주요 기능: postMessage를 통한 MCP tool 호출
   - 참고 코드:

     ```javascript
     window.parent.postMessage({
       type: 'tool',
       payload: {
         toolName: 'selectAction',
         params: { ... }
       }
     }, '*');
     ```

3. **`formatToolResponse` (`src/index.ts`)**
   - 파일 위치: `src/index.ts:256-308`
   - 주요 기능: 일관된 tool 응답 포맷 생성
   - 인터페이스: 7개 파라미터 (toolName, status, summary, gameContext, actionTaken, nextStep, workflowPosition, additionalNotes)

4. **Type 정의 패턴 (`src/types.ts`)**
   - 파일 위치: `src/types.ts:97-119`
   - 기존 Params 인터페이스: CreateGameParams, UpdateGameParams, GetGameParams, ProgressStoryParams, PromptUserActionsParams, SelectActionParams
   - 명명 규칙: `{ToolName}Params`

---

## 추가 분석 과제

### 1. MCP Client Compatibility

- **과제**: 모든 MCP client가 postMessage 패턴을 지원하는지 확인
- **분석 방법**: Claude Desktop, mcp-ui 등에서 테스트
- **대안**: postMessage 미지원 시 fallback UI (링크 또는 안내 텍스트)

### 2. Game State Persistence

- **과제**: 게임 종료 후에도 상태가 메모리에 유지되는지 확인
- **분석 방법**: `gameManager.getGame()` 호출 시 에러 처리 검증
- **대안**: 게임 종료 시 상태를 임시 저장하거나, 최소한의 요약 정보만 유지

### 3. AI Agent 행동 예측

- **과제**: selectRestart 응답 후 AI가 실제로 createGame을 호출하는지 검증
- **분석 방법**: Inspector를 통한 실제 flow 테스트
- **대안**: 더 명시적인 nextStep guidance 또는 자동 createGame 옵션

### 4. Error Handling

- **과제**: 존재하지 않는 gameId, 이미 삭제된 게임 등의 edge case 처리
- **분석 방법**: gameManager.getGame() 에러 시나리오 확인
- **대안**: 에러 발생 시 기본 createGame 안내로 fallback

---

## 구현 순서 제안

1. ✅ **Phase 1: Type 정의** - `SelectRestartParams` 추가
2. ✅ **Phase 2: Handler 구현** - `handleSelectRestart()` 메서드 작성
3. ✅ **Phase 3: Tool 등록** - setupHandlers()에 selectRestart 추가
4. ✅ **Phase 4: UI 업데이트** - generateGameOverUI()에 Restart 버튼 추가
5. ✅ **Phase 5: 테스트** - Inspector로 전체 flow 검증
6. ✅ **Phase 6: 문서화** - README에 restart flow 추가

---

## 예상 결과물

### 1. 새로운 파일

- 없음 (기존 파일 수정만)

### 2. 수정되는 파일

- `src/types.ts` - SelectRestartParams 추가
- `src/index.ts` - Tool, Handler, UI 업데이트

### 3. 테스트 시나리오

```
1. 게임 생성 및 진행
2. Game Over 조건 트리거 (예: HP 0)
3. Game Over UI 확인
4. Restart 버튼 클릭
5. selectRestart tool 호출 확인
6. AI가 createGame 호출하는지 확인
7. 새 게임 정상 시작 확인
```

---

## 리스크 및 대응 방안

| 리스크 | 영향도 | 대응 방안 |
|--------|--------|-----------|
| postMessage가 일부 client에서 작동 안 함 | 중 | Fallback UI 제공 (텍스트 안내) |
| AI가 createGame을 자동 호출 안 함 | 중 | nextStep guidance 강화 |
| 게임 상태가 메모리에서 사라짐 | 낮 | 최소 요약 정보만 사용 |
| Tool 체인 복잡도 증가 | 낮 | 명확한 문서화 |

---

## 완료 체크리스트

- [ ] SelectRestartParams 타입 정의
- [ ] handleSelectRestart 메서드 구현
- [ ] setupHandlers에 selectRestart tool 등록
- [ ] generateGameOverUI에 Restart 버튼 추가
- [ ] Import 문 업데이트
- [ ] TypeScript 컴파일 확인
- [ ] ESLint/Prettier 통과
- [ ] Inspector로 실제 flow 테스트
- [ ] README 업데이트
- [ ] Git commit 및 버전 업데이트

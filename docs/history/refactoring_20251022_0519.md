# Refactoring Plan: Game Over Restart UX Implementation

**Date:** 2025-10-22 05:19  
**Author:** AI Assistant  
**Status:** Planning

---

## ì‘ì—…ì˜ ëª©ì 

Game Over í™”ë©´ì—ì„œ ì‚¬ìš©ìê°€ ìì—°ìŠ¤ëŸ½ê²Œ ê²Œì„ì„ ì¬ì‹œì‘í•  ìˆ˜ ìˆëŠ” UXë¥¼ ì œê³µí•˜ì—¬, í”Œë ˆì´ì–´ ê²½í—˜ì„ ê°œì„ í•˜ê³  ê²Œì„ ì¬ë„ì „ì„ ìœ ë„í•©ë‹ˆë‹¤.

### í•µì‹¬ ëª©í‘œ

- Game Over UIì— Restart ë²„íŠ¼ ì¶”ê°€
- ìƒˆë¡œìš´ `selectRestart` Tool êµ¬í˜„
- ìµœì¢… ê²Œì„ ìƒíƒœ ìš”ì•½ ì œê³µ ë° AI Agentê°€ ìƒˆ ê²Œì„ì„ ì‹œì‘í•˜ë„ë¡ ìœ ë„

---

## í˜„ì¬ì˜ ìƒíƒœ / ë¬¸ì œì 

### í˜„ì¬ êµ¬ì¡°

1. **Game Over UI (`generateGameOverUI`)**
   - ì •ì  HTMLë§Œ ë°˜í™˜
   - ì‚¬ìš©ì ìƒí˜¸ì‘ìš© ìš”ì†Œ ì—†ìŒ
   - ê²Œì„ ì¢…ë£Œ í›„ ì¬ì‹œì‘ ë°©ë²•ì´ ëª…ì‹œë˜ì§€ ì•ŠìŒ

2. **Tool êµ¬ì„±**
   - 6ê°œì˜ core tools: `createGame`, `updateGame`, `getGame`, `progressStory`, `promptUserActions`, `selectAction`
   - ì¬ì‹œì‘ì„ ìœ„í•œ ì „ìš© tool ì—†ìŒ

3. **UX íë¦„**

   ```
   Game Over â†’ (ë§‰ë‹¤ë¥¸ ê³¨ëª©) â†’ ìˆ˜ë™ìœ¼ë¡œ createGame ì¬í˜¸ì¶œ í•„ìš”
   ```

### ë¬¸ì œì 

- **ë¶ˆí¸í•œ ì¬ì‹œì‘ ì ˆì°¨**: ì‚¬ìš©ìê°€ Chatì—ì„œ "ìƒˆ ê²Œì„ ì‹œì‘í•´ì¤˜"ë¥¼ ë³„ë„ë¡œ ìš”ì²­í•´ì•¼ í•¨
- **ë§¥ë½ ë‹¨ì ˆ**: ì´ì „ ê²Œì„ì˜ êµí›ˆì´ë‚˜ ìƒíƒœê°€ ìƒˆ ê²Œì„ì— ë°˜ì˜ë˜ì§€ ì•ŠìŒ
- **ì¼ê´€ì„± ë¶€ì¡±**: ë‹¤ë¥¸ actionë“¤ì€ UI ë²„íŠ¼ìœ¼ë¡œ í˜¸ì¶œ ê°€ëŠ¥í•˜ì§€ë§Œ, ì¬ì‹œì‘ì€ ë¶ˆê°€ëŠ¥

---

## ë³€ê²½ ì´í›„ì˜ ìƒíƒœ / í•´ê²° íŒì • ê¸°ì¤€

### ëª©í‘œ ìƒíƒœ

1. **Game Over UI**
   - "ğŸ”„ Restart Game" ë²„íŠ¼ ì¶”ê°€
   - ë²„íŠ¼ í´ë¦­ ì‹œ `selectRestart` tool ìë™ í˜¸ì¶œ
   - ê¸°ì¡´ `selectAction` íŒ¨í„´ê³¼ ì¼ê´€ëœ UX

2. **ìƒˆë¡œìš´ Tool: `selectRestart`**
   - ìµœì¢… ê²Œì„ ìƒíƒœ ì¡°íšŒ ë° ìš”ì•½
   - AI Agentì—ê²Œ `createGame` í˜¸ì¶œì„ ê¶Œì¥í•˜ëŠ” ì‘ë‹µ ë°˜í™˜
   - Text partë¡œ ê²Œì„ ìš”ì•½ + ë‹¤ìŒ ë‹¨ê³„ ê°€ì´ë“œ ì œê³µ

3. **UX íë¦„**

   ```
   Game Over â†’ Restart ë²„íŠ¼ í´ë¦­ â†’ selectRestart í˜¸ì¶œ â†’ 
   ìµœì¢… ìƒíƒœ ìš”ì•½ + createGame ê¶Œì¥ â†’ AIê°€ ìƒˆ ê²Œì„ ìƒì„±
   ```

### í•´ê²° íŒì • ê¸°ì¤€

âœ… **ì„±ê³µ ì¡°ê±´:**

- [ ] Game Over UIì— Restart ë²„íŠ¼ì´ ë Œë”ë§ë¨
- [ ] ë²„íŠ¼ í´ë¦­ ì‹œ `selectRestart` toolì´ ì˜¬ë°”ë¥´ê²Œ í˜¸ì¶œë¨
- [ ] `selectRestart` ì‘ë‹µì— ìµœì¢… ê²Œì„ ìƒíƒœ ìš”ì•½ì´ í¬í•¨ë¨
- [ ] AI Agentê°€ ì‘ë‹µì„ ë°›ê³  `createGame`ì„ ìë™ìœ¼ë¡œ í˜¸ì¶œí•¨
- [ ] ìƒˆ ê²Œì„ì´ ì •ìƒì ìœ¼ë¡œ ì‹œì‘ë¨

âš ï¸ **ê²€ì¦ í¬ì¸íŠ¸:**

- postMessage íŒ¨í„´ì´ MCP clientì—ì„œ ì •ìƒ ì‘ë™
- Tool ì²´ì¸ (selectRestart â†’ createGame) ìì—°ìŠ¤ëŸ½ê²Œ ì—°ê²°
- ì—ëŸ¬ í•¸ë“¤ë§ (ì¡´ì¬í•˜ì§€ ì•ŠëŠ” gameId ë“±)

---

## ìˆ˜ì •ì´ í•„ìš”í•œ ì½”ë“œ ë° ìˆ˜ì • ë¶€ë¶„

### 1. Type ì •ì˜ ì¶”ê°€ (`src/types.ts`)

**ìœ„ì¹˜:** Tool parameter interfaces ì„¹ì…˜

```typescript
export interface SelectRestartParams {
  gameId: string;
}
```

**ì¶”ê°€ ìœ„ì¹˜:** `SelectActionParams` ë‹¤ìŒ

---

### 2. Tool ë“±ë¡ (`src/index.ts` - `setupHandlers()`)

**ìœ„ì¹˜:** `ListToolsRequestSchema` handlerì˜ tools ë°°ì—´

```typescript
{
  name: 'selectRestart',
  description: 
    "Restart the game after game over. Retrieves final game state summary and instructs to create a new game. This should be called when the player clicks the Restart button on the Game Over screen.",
  inputSchema: {
    type: 'object',
    properties: {
      gameId: { 
        type: 'string', 
        description: 'ID of the ended game' 
      }
    },
    required: ['gameId']
  }
}
```

**ì¶”ê°€ ìœ„ì¹˜:** `selectAction` tool ì •ì˜ ë‹¤ìŒ

---

### 3. Tool í˜¸ì¶œ í•¸ë“¤ëŸ¬ ì¶”ê°€ (`src/index.ts` - `setupHandlers()`)

**ìœ„ì¹˜:** CallToolRequestSchema handlerì˜ switch ë¬¸

```typescript
case 'selectRestart':
  result = await this.handleSelectRestart(
    toolArgs as unknown as SelectRestartParams
  );
  break;
```

**ì¶”ê°€ ìœ„ì¹˜:** `selectAction` case ë‹¤ìŒ

---

### 4. Handler ë©”ì„œë“œ êµ¬í˜„ (`src/index.ts`)

**ìœ„ì¹˜:** RPGMCPServer í´ë˜ìŠ¤ ë‚´ë¶€, `handleSelectAction` ë‹¤ìŒ

```typescript
private async handleSelectRestart(params: SelectRestartParams): Promise<CallToolResult> {
  if (!params.gameId) {
    throw new Error('gameId parameter is required');
  }

  const result = this.gameManager.getGame(params.gameId);

  // ìµœì¢… ìƒíƒœ ìš”ì•½
  const finalState = {
    title: result.game.state.title,
    endedAt: result.game.updatedAt,
    characters: result.game.state.characters,
    world: result.game.state.world,
    finalProgress: result.game.state.lastStoryProgress,
    historyCount: result.game.state.gameHistory?.length || 0,
  };

  const responseText = this.formatToolResponse(
    'selectRestart',
    'success',
    'Player requested game restart',
    {
      gameId: params.gameId,
      title: result.game.state.title,
      keyState: [
        `Game ended at: ${result.game.updatedAt.toISOString()}`,
        `Total decisions made: ${finalState.historyCount}`,
        'Ready to start fresh',
      ],
    },
    `Game "${result.game.state.title}" has ended. Player wants to start a new adventure.`,
    {
      tool: 'createGame',
      reason: 'Create a fresh game with new initial state for the player',
      params: {
        initialStateInJson: {
          title: 'Suggest a new adventure based on the previous game experience',
          characters: 'Create new characters (can reference previous if helpful)',
          world: 'Design a new world and starting situation',
        },
      },
    },
    'Restart Flow: Game Over â†’ [selectRestart] â†’ createGame â†’ progressStory',
    [
      'Previous game summary provided for context',
      'Player is ready for a new adventure',
      'Consider lessons learned from previous game when creating new one',
      `Previous game had ${finalState.historyCount} story decisions`,
    ]
  );

  return {
    content: [{ type: 'text', text: responseText }],
  };
}
```

---

### 5. Game Over UI ì—…ë°ì´íŠ¸ (`src/index.ts` - `generateGameOverUI()`)

**ìˆ˜ì • ë¶€ë¶„:** HTML ë‚´ë¶€, retry-message ì„¹ì…˜ ë‹¤ìŒì— ë²„íŠ¼ ì¶”ê°€

```typescript
<div class="restart-button-section">
  <button class="restart-button" onclick="selectRestart('${gameId}')">
    ğŸ”„ Restart Game
  </button>
</div>

<style>
  .restart-button-section {
    margin-top: 30px;
    text-align: center;
  }
  .restart-button {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 10px;
    padding: 15px 40px;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
  }
  .restart-button:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.6);
  }
  .restart-button:active {
    transform: translateY(0);
  }
</style>

<script>
  function selectRestart(gameId) {
    // MCP ë„êµ¬ í˜¸ì¶œ
    window.parent.postMessage({
      type: 'tool',
      payload: {
        toolName: 'selectRestart',
        params: { gameId: gameId }
      }
    }, '*');
    
    // ë²„íŠ¼ ë¹„í™œì„±í™” ë° í”¼ë“œë°±
    const button = event.target;
    button.disabled = true;
    button.textContent = 'ğŸ”„ Restarting...';
    button.style.opacity = '0.6';
  }
</script>
```

---

## ì¬ì‚¬ìš© ê°€ëŠ¥í•œ ì—°ê´€ ì½”ë“œ

### ì°¸ê³ í•  ê¸°ì¡´ íŒ¨í„´

1. **`handleSelectAction` (`src/index.ts`)**
   - íŒŒì¼ ìœ„ì¹˜: `src/index.ts:779-831`
   - ì£¼ìš” ê¸°ëŠ¥: ì‚¬ìš©ì ì„ íƒ ì²˜ë¦¬ ë° ê²Œì„ íˆìŠ¤í† ë¦¬ ì—…ë°ì´íŠ¸
   - ì¸í„°í˜ì´ìŠ¤: `SelectActionParams { gameId, selectedOption, selectedIndex }`
   - ì°¸ê³  í¬ì¸íŠ¸: formatToolResponse ì‚¬ìš© íŒ¨í„´, nextStep ì„¤ì •

2. **`generateGameUI` JavaScript ì„¹ì…˜ (`src/index.ts`)**
   - íŒŒì¼ ìœ„ì¹˜: `src/index.ts:604-776`
   - ì£¼ìš” ê¸°ëŠ¥: postMessageë¥¼ í†µí•œ MCP tool í˜¸ì¶œ
   - ì°¸ê³  ì½”ë“œ:

     ```javascript
     window.parent.postMessage({
       type: 'tool',
       payload: {
         toolName: 'selectAction',
         params: { ... }
       }
     }, '*');
     ```

3. **`formatToolResponse` (`src/index.ts`)**
   - íŒŒì¼ ìœ„ì¹˜: `src/index.ts:256-308`
   - ì£¼ìš” ê¸°ëŠ¥: ì¼ê´€ëœ tool ì‘ë‹µ í¬ë§· ìƒì„±
   - ì¸í„°í˜ì´ìŠ¤: 7ê°œ íŒŒë¼ë¯¸í„° (toolName, status, summary, gameContext, actionTaken, nextStep, workflowPosition, additionalNotes)

4. **Type ì •ì˜ íŒ¨í„´ (`src/types.ts`)**
   - íŒŒì¼ ìœ„ì¹˜: `src/types.ts:97-119`
   - ê¸°ì¡´ Params ì¸í„°í˜ì´ìŠ¤: CreateGameParams, UpdateGameParams, GetGameParams, ProgressStoryParams, PromptUserActionsParams, SelectActionParams
   - ëª…ëª… ê·œì¹™: `{ToolName}Params`

---

## ì¶”ê°€ ë¶„ì„ ê³¼ì œ

### 1. MCP Client Compatibility

- **ê³¼ì œ**: ëª¨ë“  MCP clientê°€ postMessage íŒ¨í„´ì„ ì§€ì›í•˜ëŠ”ì§€ í™•ì¸
- **ë¶„ì„ ë°©ë²•**: Claude Desktop, mcp-ui ë“±ì—ì„œ í…ŒìŠ¤íŠ¸
- **ëŒ€ì•ˆ**: postMessage ë¯¸ì§€ì› ì‹œ fallback UI (ë§í¬ ë˜ëŠ” ì•ˆë‚´ í…ìŠ¤íŠ¸)

### 2. Game State Persistence

- **ê³¼ì œ**: ê²Œì„ ì¢…ë£Œ í›„ì—ë„ ìƒíƒœê°€ ë©”ëª¨ë¦¬ì— ìœ ì§€ë˜ëŠ”ì§€ í™•ì¸
- **ë¶„ì„ ë°©ë²•**: `gameManager.getGame()` í˜¸ì¶œ ì‹œ ì—ëŸ¬ ì²˜ë¦¬ ê²€ì¦
- **ëŒ€ì•ˆ**: ê²Œì„ ì¢…ë£Œ ì‹œ ìƒíƒœë¥¼ ì„ì‹œ ì €ì¥í•˜ê±°ë‚˜, ìµœì†Œí•œì˜ ìš”ì•½ ì •ë³´ë§Œ ìœ ì§€

### 3. AI Agent í–‰ë™ ì˜ˆì¸¡

- **ê³¼ì œ**: selectRestart ì‘ë‹µ í›„ AIê°€ ì‹¤ì œë¡œ createGameì„ í˜¸ì¶œí•˜ëŠ”ì§€ ê²€ì¦
- **ë¶„ì„ ë°©ë²•**: Inspectorë¥¼ í†µí•œ ì‹¤ì œ flow í…ŒìŠ¤íŠ¸
- **ëŒ€ì•ˆ**: ë” ëª…ì‹œì ì¸ nextStep guidance ë˜ëŠ” ìë™ createGame ì˜µì…˜

### 4. Error Handling

- **ê³¼ì œ**: ì¡´ì¬í•˜ì§€ ì•ŠëŠ” gameId, ì´ë¯¸ ì‚­ì œëœ ê²Œì„ ë“±ì˜ edge case ì²˜ë¦¬
- **ë¶„ì„ ë°©ë²•**: gameManager.getGame() ì—ëŸ¬ ì‹œë‚˜ë¦¬ì˜¤ í™•ì¸
- **ëŒ€ì•ˆ**: ì—ëŸ¬ ë°œìƒ ì‹œ ê¸°ë³¸ createGame ì•ˆë‚´ë¡œ fallback

---

## êµ¬í˜„ ìˆœì„œ ì œì•ˆ

1. âœ… **Phase 1: Type ì •ì˜** - `SelectRestartParams` ì¶”ê°€
2. âœ… **Phase 2: Handler êµ¬í˜„** - `handleSelectRestart()` ë©”ì„œë“œ ì‘ì„±
3. âœ… **Phase 3: Tool ë“±ë¡** - setupHandlers()ì— selectRestart ì¶”ê°€
4. âœ… **Phase 4: UI ì—…ë°ì´íŠ¸** - generateGameOverUI()ì— Restart ë²„íŠ¼ ì¶”ê°€
5. âœ… **Phase 5: í…ŒìŠ¤íŠ¸** - Inspectorë¡œ ì „ì²´ flow ê²€ì¦
6. âœ… **Phase 6: ë¬¸ì„œí™”** - READMEì— restart flow ì¶”ê°€

---

## ì˜ˆìƒ ê²°ê³¼ë¬¼

### 1. ìƒˆë¡œìš´ íŒŒì¼

- ì—†ìŒ (ê¸°ì¡´ íŒŒì¼ ìˆ˜ì •ë§Œ)

### 2. ìˆ˜ì •ë˜ëŠ” íŒŒì¼

- `src/types.ts` - SelectRestartParams ì¶”ê°€
- `src/index.ts` - Tool, Handler, UI ì—…ë°ì´íŠ¸

### 3. í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

```
1. ê²Œì„ ìƒì„± ë° ì§„í–‰
2. Game Over ì¡°ê±´ íŠ¸ë¦¬ê±° (ì˜ˆ: HP 0)
3. Game Over UI í™•ì¸
4. Restart ë²„íŠ¼ í´ë¦­
5. selectRestart tool í˜¸ì¶œ í™•ì¸
6. AIê°€ createGame í˜¸ì¶œí•˜ëŠ”ì§€ í™•ì¸
7. ìƒˆ ê²Œì„ ì •ìƒ ì‹œì‘ í™•ì¸
```

---

## ë¦¬ìŠ¤í¬ ë° ëŒ€ì‘ ë°©ì•ˆ

| ë¦¬ìŠ¤í¬ | ì˜í–¥ë„ | ëŒ€ì‘ ë°©ì•ˆ |
|--------|--------|-----------|
| postMessageê°€ ì¼ë¶€ clientì—ì„œ ì‘ë™ ì•ˆ í•¨ | ì¤‘ | Fallback UI ì œê³µ (í…ìŠ¤íŠ¸ ì•ˆë‚´) |
| AIê°€ createGameì„ ìë™ í˜¸ì¶œ ì•ˆ í•¨ | ì¤‘ | nextStep guidance ê°•í™” |
| ê²Œì„ ìƒíƒœê°€ ë©”ëª¨ë¦¬ì—ì„œ ì‚¬ë¼ì§ | ë‚® | ìµœì†Œ ìš”ì•½ ì •ë³´ë§Œ ì‚¬ìš© |
| Tool ì²´ì¸ ë³µì¡ë„ ì¦ê°€ | ë‚® | ëª…í™•í•œ ë¬¸ì„œí™” |

---

## ì™„ë£Œ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] SelectRestartParams íƒ€ì… ì •ì˜
- [ ] handleSelectRestart ë©”ì„œë“œ êµ¬í˜„
- [ ] setupHandlersì— selectRestart tool ë“±ë¡
- [ ] generateGameOverUIì— Restart ë²„íŠ¼ ì¶”ê°€
- [ ] Import ë¬¸ ì—…ë°ì´íŠ¸
- [ ] TypeScript ì»´íŒŒì¼ í™•ì¸
- [ ] ESLint/Prettier í†µê³¼
- [ ] Inspectorë¡œ ì‹¤ì œ flow í…ŒìŠ¤íŠ¸
- [ ] README ì—…ë°ì´íŠ¸
- [ ] Git commit ë° ë²„ì „ ì—…ë°ì´íŠ¸

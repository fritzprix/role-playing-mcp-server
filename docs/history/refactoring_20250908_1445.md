# GameManager 메서드 반환값 최적화 리팩토링 계획

## 작업의 목적

GameManager 클래스의 메서드들이 항상 전체 Game 객체를 반환하는 현재 구조를 개선하여, 각 메서드의 용도에 맞는 핵심 정보만 반환하도록 최적화함으로써 네트워크 트래픽 감소, 응답 속도 향상, 그리고 API 사용성을 개선한다.

## 현재의 상태 / 문제점

### 현재 상태
- `GameManager`의 모든 메서드(`createGame`, `updateGame`, `getGame`, `selectAction`, `progressStory`, `promptUserActions`)가 전체 `Game` 객체를 반환
- 게임 상태가 복잡해질수록 불필요한 데이터 전송이 증가
- 클라이언트에서 필요한 정보를 찾기 위해 전체 객체를 파싱해야 함

### 문제점
1. **성능 이슈**: 빈번하게 호출되는 `progressStory`, `promptUserActions` 메서드에서 불필요한 데이터 전송
2. **API 복잡성**: 클라이언트가 메서드별로 필요한 정보를 전체 객체에서 추출해야 함
3. **유지보수성**: 게임 상태가 커질수록 반환 데이터의 크기가 기하급수적으로 증가

## 추가 분석 과제

1. **타입 시스템 검토**: 현재 `GameResponse` 타입이 모든 메서드에 적용 가능한지 분석
2. **클라이언트 호환성**: 기존 클라이언트 코드에 미치는 영향 분석
3. **성능 측정**: 리팩토링 전후 응답 크기 및 처리 시간 비교 측정 방법 수립

## 변경 이후의 상태 / 해결 판정 기준

### 목표 상태
- 각 메서드가 해당 기능에 특화된 최소한의 데이터만 반환
- `updateGame`은 전체 상태, 나머지 메서드들은 핵심 정보만 반환
- 타입 안정성을 유지하면서 API 사용성 향상

### 해결 판정 기준
1. **기능성**: 모든 기존 기능이 정상 동작
2. **성능**: `progressStory`, `promptUserActions` 응답 크기 50% 이상 감소
3. **타입 안정성**: TypeScript 컴파일 에러 없음
4. **호환성**: 기존 클라이언트 코드 최소 변경으로 동작

## 수정이 필요한 코드 및 수정부분의 코드 스니핏

### 1. progressStory 메서드
**파일**: `src/gameManager.ts`
**현재 코드**:
```typescript
return {
  game,
  nextActions: ['promptUserActions'],
};
```

**수정 후**:
```typescript
return {
  game: {
    gameId: game.gameId,
    prevProgress,
    currentProgress: progress,
    updatedAt: game.updatedAt
  },
  nextActions: ['promptUserActions'],
};
```

### 2. promptUserActions 메서드
**현재 코드**:
```typescript
return {
  game,
  nextActions: [],
};
```

**수정 후**:
```typescript
return {
  game: {
    gameId: game.gameId,
    progress: game.state.lastStoryProgress,
    options,
    promptTime: game.state._lastPromptTime
  },
  nextActions: [],
};
```

### 3. selectAction 메서드
**현재 코드**:
```typescript
return {
  game,
  nextActions: ["updateGame"]
};
```

**수정 후**:
```typescript
return {
  game: {
    gameId: game.gameId,
    situation: game.state.lastStoryProgress,
    selectedOption,
    selectedIndex,
    timestamp: game.state.selectedAction.timestamp
  },
  nextActions: ["updateGame"]
};
```

## 재사용 가능한 연관 코드

### 관련 파일
- **주요 파일**: `src/gameManager.ts` - GameManager 클래스 구현
- **타입 정의**: `src/types.ts` - GameResponse, Game, GameState 인터페이스
- **진입점**: `src/index.ts` - MCP 서버 도구 정의

### 주요 인터페이스
```typescript
// src/types.ts
interface GameResponse {
  game: Game | Partial<Game>;  // 유연한 반환 타입 지원
  nextActions: string[];
}

interface Game {
  gameId: string;
  state: GameState;
  createdAt: Date;
  updatedAt: Date;
}
```

### 재사용 가능한 패턴
1. **선택적 반환 객체 생성**: 메서드별로 필요한 필드만 포함하는 객체 생성 패턴
2. **타입 안정성 유지**: Partial<Game> 타입을 활용한 유연한 반환 타입
3. **일관된 메타데이터**: gameId, updatedAt 등 공통 메타데이터는 모든 응답에 포함

### 테스트 전략
1. **단위 테스트**: 각 메서드의 반환 객체 구조 검증
2. **통합 테스트**: 메서드 간 체이닝 동작 확인
3. **성능 테스트**: 응답 크기 측정 및 비교

## 구현 우선순위
1. **1차**: `progressStory`, `promptUserActions` (빈번한 호출)
2. **2차**: `selectAction` (중간 빈도)
3. **3차**: `createGame`, `getGame` (필요시 검토)

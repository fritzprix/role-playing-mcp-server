# Refactoring Plan: Delta 변경사항 UI 표시 기능 추가

## 작업의 목적

`promptUserAction` 호출 시 이전 `promptUserAction` 이후에 발생한 모든 게임 상태 변경사항(delta)을 사용자에게 시각적으로 표시하여, 게임 진행 중 어떤 변화가 있었는지 명확하게 알려주는 기능을 구현한다.

## 현재의 상태 / 문제점

- `updateGame` 메서드에서 게임 상태 변경이 발생하지만, 사용자는 무엇이 바뀌었는지 알 수 없음
- `promptUserAction`에서 생성되는 UI에는 현재 스토리와 선택지만 표시되고, 최근 변경사항은 표시되지 않음
- 게임 상태 변경 내역이 로그로만 출력되어 사용자 경험이 떨어짐
- 연속된 `updateGame` 호출 시 중간 변경사항들이 누적되지 않아 전체적인 변화를 파악하기 어려움

## 추가 분석 과제

- 게임 상태의 중첩된 객체 구조에서 의미 있는 변경사항을 어떻게 사용자 친화적으로 표현할지 분석
- 대량의 배열 변경(예: 인벤토리 아이템 추가/삭제)에 대한 효과적인 표시 방법 검토
- 게임 성능에 미치는 영향 최소화 방안 검토

## 변경 이후의 상태 / 해결 판정 기준

### 기능적 요구사항

1. `promptUserAction` 호출 시 이전 호출 이후의 모든 변경사항이 UI에 리스트 형태로 표시됨
2. 같은 필드의 여러 번 변경 시 최초값 → 최종값으로 요약하여 표시
3. 변경사항 표시 후 delta 정보가 자동으로 clear됨
4. 사용자 친화적인 변경 설명 메시지 제공

### 성능 요구사항

- Delta 저장으로 인한 메모리 오버헤드 최소화
- UI 렌더링 성능에 영향 없음

## 수정이 필요한 코드 및 수정부분

### 1. `src/types.ts` - 타입 정의 추가

```typescript
/**
 * Delta 정보 타입
 */
export interface DeltaInfo {
  field: string;
  initialValue: any;
  finalValue: any;
  timestamp: Date;
  description: string;
}

export interface GameState {
  // ...existing properties...
  _pendingDeltas?: DeltaInfo[]; // promptUserAction 사이의 누적 변경사항
  _lastPromptTime?: Date; // 마지막 promptUserAction 호출 시간
  // ...rest of properties...
}
```

### 2. `src/gameManager.ts` - Delta 관리 로직 추가

```typescript
// updateGame 메서드 수정
updateGame(gameId: string, fieldSelector: string, value: unknown): GameResponse {
  // ...existing code...
  
  // Delta 정보 추가/업데이트
  this.addOrUpdateDelta(newState, cleanPath, value);
  
  // ...rest of existing code...
}

// 새로운 메서드들 추가
private addOrUpdateDelta(state: GameState, field: string, newValue: unknown): void;
private getNestedValue(obj: Record<string, unknown>, path: string): unknown;
private generateDeltaDescription(field: string, initialValue: unknown, finalValue: unknown): string;

// promptUserActions 메서드 수정 - delta clear 로직 추가
promptUserActions(gameId: string, options: string[]): GameResponse {
  // ...existing code...
  
  // 현재 시간을 lastPromptTime으로 설정
  game.state._lastPromptTime = new Date();
  
  // ...existing code...
}
```

### 3. `src/index.ts` - UI 생성 로직 수정

```typescript
// generateGameUI 메서드 수정
private generateGameUI(storyProgress: string, options: string[], gameId: string): string {
  // 게임 상태에서 pendingDeltas 가져오기
  const game = this.gameManager.getGame(gameId).game;
  const pendingDeltas = game.state._pendingDeltas || [];
  
  // Delta 섹션 HTML 생성
  const deltaSection = this.generateDeltaSection(pendingDeltas);
  
  // 기존 UI에 delta 섹션 추가
  // ...rest of implementation...
}

// 새로운 메서드 추가
private generateDeltaSection(deltas: DeltaInfo[]): string;

// handlePromptUserActions 메서드 수정 - delta clear 로직 추가
private async handlePromptUserActions(params: PromptUserActionsParams): Promise<CallToolResult> {
  // UI 생성 후 pendingDeltas clear
  const result = this.gameManager.promptUserActions(params.gameId, params.options);
  
  // Delta clear
  const game = this.gameManager.getGame(params.gameId).game;
  game.state._pendingDeltas = [];
  
  // ...existing UI generation code...
}
```

## 재사용 가능한 연관 코드

### 주요 파일 및 기능

- `src/gameManager.ts`: 게임 상태 관리 및 delta 추적 로직
- `src/index.ts`: UI 생성 및 MCP 서버 핸들링
- `src/types.ts`: 타입 정의

### 관련 인터페이스

- `GameState`: 게임 상태 정의
- `GameResponse`: 게임 응답 구조
- `PromptUserActionsParams`: promptUserActions 파라미터

### 기존 활용 가능한 메서드

- `setNestedValue()`: 중첩 객체 값 설정 로직 (delta 추적에 활용)
- `parsePath()`: 경로 파싱 로직 (필드명 처리에 활용)
- `generateGameUI()`: UI 생성 기본 구조 (delta 표시 영역 추가)

### CSS 스타일 확장

- 기존 `.story-section`, `.actions-section` 스타일을 참조하여 `.delta-section` 스타일 추가
- 애니메이션 효과로 변경사항 강조 표시
